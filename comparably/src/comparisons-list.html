<link rel="import" href="comparison-column.html" />

<template id="comparisons-list">
    <style>
        :host {
            height: auto;
            display: block;
            white-space: nowrap;
        }
    </style>

    <!-- Populated with a comparison-list for each <li> in the content
         by updateShadowDom below, on attach and on any changes -->

</template>

<script>
    (function() {
        var element = Object.create(HTMLElement.prototype);

        var thisDocument = document.currentScript.ownerDocument;
        var template = thisDocument.querySelector("template#comparisons-list");

        element.createdCallback = function() {
            var content = this;
            var shadowDom = this.createShadowRoot();

            var templateContent = document.importNode(template.content, true);
            shadowDom.appendChild(templateContent);

            new MutationObserver(function (mutation) {
                updateShadowDom(shadowDom, content);
            }).observe(content, { childList: true, characterData: true, subtree: true });

            updateShadowDom(shadowDom, content);
        };

        function updateShadowDom(shadowDom, content) {
            var comparisonDomContent = content.querySelectorAll("comparisons-list > ul > li");
            // Need to clone these nodes, so we can reattach them within comparison columns instead
            var comparisonData = asArray(comparisonDomContent).map(function (itemDataDom) {
                return itemDataDom.cloneNode(true);
            });

            var columns = comparisonData.map(function (comparisonItem) {
                // Transform the content into comparison columns
                var comparisonColumn = document.createElement("comparison-column");
                asArray(comparisonItem.children).forEach(function (node) {
                    comparisonColumn.appendChild(node);
                });
                return comparisonColumn;
            });

            replaceComparisonColumns(shadowDom, columns);
        };

        function replaceComparisonColumns(rootNode, children) {
            asArray(rootNode.querySelectorAll("comparison-column")).forEach(function (column) {
                rootNode.removeChild(column);
            });
            asArray(children).forEach(function (child) {
                rootNode.appendChild(child);
            });
        }

        function asArray(obj) {
            return [].map.call(obj, function (element) {
                return element;
            });
        }

        document.registerElement('comparisons-list', {
            prototype: element
        });
    }());
</script>
