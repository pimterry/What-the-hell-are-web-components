<link rel="import" href="item-title.html" />
<link rel="import" href="item-facet.html" />
<link rel="import" href="add-facet.html" />

<template id="comparison-item">
    <style>
        section {
            display: inline-block;

            width: 600px;;
            margin: 40px 50px;

            background-color: #fff;

            border-radius: 20px;
            padding-bottom: 20px;
        }
    </style>

    <section>
        <item-title>
            <content select="h1"></content>
        </item-title>
    </section>
</template>

<script>
    (function() {
        var element = Object.create(HTMLElement.prototype);

        var thisDocument = document.currentScript.ownerDocument;
        var template = thisDocument.querySelector("template#comparison-item");

        element.createdCallback = function() {
            var content = this;
            var shadowDom = this.createShadowRoot();

            var templateContent = document.importNode(template.content, true);
            shadowDom.appendChild(templateContent);

            new MutationObserver(function (mutation) {
                updateShadowDom(shadowDom, content);
            }).observe(content, { childList: true, characterData: true, subtree: true });

            updateShadowDom(shadowDom, content);
        };

        function updateShadowDom(shadowDom, content) {
            var itemDomContent = content.querySelectorAll("comparison-item > ul > li");
            // Need to clone these nodes, so we can reattach them within comparison columns instead
            var itemData = asArray(itemDomContent).map(function (rowDataDom) {
                return rowDataDom.cloneNode(true);
            });

            var itemFacets = itemData.map(function (facetData) {
                // Transform the content into comparison columns
                var itemFacet = document.createElement("item-facet");

                asArray(facetData.childNodes).forEach(function (node) {
                    itemFacet.appendChild(node);
                });

                if (facetData.classList.length) {
                    itemFacet.classList.add(facetData.classList.toString());
                }

                return itemFacet;
            });

            itemFacets.push(document.createElement("add-facet"));

            replaceItemFacets(shadowDom.querySelector("section"), itemFacets);
        };

        function replaceItemFacets(rootNode, children) {
            asArray(rootNode.querySelectorAll("item-facet, add-facet")).forEach(function (facet) {
                rootNode.removeChild(facet);
            });
            asArray(children).forEach(function (child) {
                rootNode.appendChild(child);
            });
        }

        function asArray(obj) {
            return [].map.call(obj, function (element) {
                return element;
            });
        }

        document.registerElement('comparison-item', {
            prototype: element
        });
    }());
</script>
